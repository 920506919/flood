<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Earth & Photo Wall Viewer</title>

  <!-- Cesium 静态资源设置 -->
  <script>window.CESIUM_BASE_URL = '../Build/CesiumUnminified';</script>
  <link rel="stylesheet" href="../Build/CesiumUnminified/Widgets/widgets.css"/>
  <script src="../Build/CesiumUnminified/Cesium.js"></script>

  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
    /* 登录界面 */
    #login-container {
      position: absolute;
      width: 100%; height: 100%;
      background: linear-gradient(to bottom, #222, #444);
      display: flex; justify-content: center; align-items: center;
      color: white; z-index: 20;
    }
    #login-box {
      background: rgba(0,0,0,0.6);
      padding: 40px; border-radius: 10px;
      box-shadow: 0 0 10px black; text-align: center;
    }
    #login-box input {
      display: block; width: 200px; margin: 10px auto;
      padding: 8px; border-radius: 5px; border: none;
    }
    #login-box button {
      padding: 10px 20px; background: #2d8fd3;
      color: white; border: none; border-radius: 5px;
      cursor: pointer;
    }

    /* Cesium 容器 */
    #cesiumContainer {
      width: 100%; height: 100%;
      display: none; position: relative; z-index: 10;
    }
    /* 年份选择器 */
    #yearSelector {
      position: absolute; top: 10px; left: 10px;
      z-index: 100; padding: 6px 12px; border-radius: 5px;
      background: rgba(255,255,255,0.9); font-size: 16px;
    }
  </style>
</head>
<body>

  <!-- 登录界面 -->
  <div id="login-container">
    <div id="login-box">
      <h2>登录地球系统</h2>
      <input type="text" id="username" placeholder="用户名" value="admin"/>
      <input type="password" id="password" placeholder="密码" value="admin"/>
      <button onclick="login()">登录</button>
    </div>
  </div>

  <!-- Cesium 容器 -->
  <div id="cesiumContainer">
    <select id="yearSelector" onchange="switchData()">
      <option value="output1.geojson">2021年数据</option>
      <option value="output4.geojson">2024年数据</option>
      <option value="output.geojson" selected>预测数据</option>
    </select>
  </div>

  <script>
    // Cesium 访问 Token
    const CESIUM_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI0NTNiZTdhZS1iMDE0LTQ0NzMtYWY0Ny04YjI5NTYwN2YzZjciLCJpZCI6Mjg1ODk4LCJpYXQiOjE3NDI0MzIyODV9.a8VuYB5zSzRQZS9OA1UwqbcH7lgV49Sz_GPVQIl2GxQ';

    let viewer, currentDataSource;

    // 登录验证
    function login() {
      const user = document.getElementById('username').value;
      const pass = document.getElementById('password').value;
      if (user === 'admin' && pass === 'admin') {
        document.getElementById('login-container').style.display = 'none';
        document.getElementById('cesiumContainer').style.display = 'block';
        initCesium();
      } else {
        alert('用户名或密码错误！');
      }
    }

    // 初始化 Cesium 场景
    function initCesium() {
      Cesium.Ion.defaultAccessToken = CESIUM_TOKEN;
      viewer = new Cesium.Viewer('cesiumContainer', {
        animation: false, timeline: false,
        sceneModePicker: true, navigationHelpButton: true,
        fullscreenButton: true, geocoder: true, homeButton: true,
        infoBox: true, selectionIndicator: true,
        baseLayerPicker: true,
        terrainProvider: new Cesium.EllipsoidTerrainProvider()
      });

      // 异步加载 Ion 地形
      Cesium.CesiumTerrainProvider.fromIonAssetId(1)
        .then(tp => { viewer.terrainProvider = tp; console.log('地形加载成功'); });

      // 自转效果
      let spinning = true;
      viewer.scene.preRender.addEventListener(() => {
        if (spinning) {
          viewer.scene.camera.rotate(Cesium.Cartesian3.UNIT_Z, -0.002);
        }
      });

      // 初始漫游：3 秒后停止自转并飞到指定位置
      setTimeout(() => {
        spinning = false;
        viewer.camera.flyTo({
          destination: Cesium.Cartesian3.fromDegrees(112.98, 28.1858, 15000),
          duration: 5,
          orientation: {
            heading: Cesium.Math.toRadians(0),
            pitch:   Cesium.Math.toRadians(-30),
            roll:    0
          },
          complete: () => {
            viewer.camera.flyTo({
              destination: Cesium.Cartesian3.fromDegrees(112.98, 28.1858, 5000),
              duration: 3
            });
          }
        });
      }, 3000);

      // 动态水流线
      const waterFlow = viewer.entities.add({
        polyline: {
          positions: [
            Cesium.Cartesian3.fromDegrees(112.9388, 28.2278),
            Cesium.Cartesian3.fromDegrees(112.94,   28.2290)
          ],
          width: 5,
          material: Cesium.Color.BLUE.withAlpha(0.6)
        }
      });
      let t = 0;
      viewer.scene.preRender.addEventListener(() => {
        waterFlow.polyline.material = Cesium.Color.fromAlpha(
          Cesium.Color.BLUE,
          0.6 + Math.sin(t * 0.05) * 0.2
        );
        t++;
      });

      // 照片墙数据与创建函数
      const images = [
        { name: 'Train Station', path: '../Apps/SampleData/2024trainstation.png', lon: 113.0057506, lat: 28.1960111 },
        { name: 'Orange Island',   path: '../Apps/SampleData/橘子洲头.png',      lon: 112.9545,      lat: 28.1695    },
        { name: 'Xiyimen',         path: '../Apps/SampleData/喜盈门.png',      lon: 113.0285,      lat: 28.1360    }
      ];
      const baseH = 5, wallH = 200, meters = 400, earthR = 6378137.0;
      function createPhotoWall(lon, lat, img, id) {
        const dLon = meters / (earthR * Math.cos(Cesium.Math.toRadians(lat))) * (180/Math.PI);
        const wLon = lon - dLon/2, eLon = lon + dLon/2;
        const pos = Cesium.Cartesian3.fromDegreesArrayHeights([
          wLon, lat, baseH, eLon, lat, baseH
        ]);
        viewer.entities.add({
          name: id,
          wall: {
            positions: pos,
            minimumHeights: [baseH, baseH],
            maximumHeights: [baseH+wallH, baseH+wallH],
            material: new Cesium.ImageMaterialProperty({
              image: img,
              repeat: new Cesium.Cartesian2(1,1),
              transparent: true
            })
          }
        });
      }
      // 检测并创建
      images.forEach(o => {
        const tester = new Image();
        tester.onload  = () => console.log(`✅ 图片加载成功: ${o.path}`);
        tester.onerror = () => console.error(`❌ 图片加载失败: ${o.path}`);
        tester.src     = o.path;
        createPhotoWall(o.lon, o.lat, o.path, o.name);
      });

      // 加载初始预测 GeoJSON
      loadGeoJSON('output.geojson');
    }

    // GeoJSON 加载 和 切换
    function loadGeoJSON(file) {
      if (currentDataSource) {
        viewer.dataSources.remove(currentDataSource);
      }
      Cesium.GeoJsonDataSource.load('../Apps/SampleData/' + file)
        .then(ds => {
          currentDataSource = ds;
          viewer.dataSources.add(ds);
        })
        .catch(err => console.error('加载GeoJSON失败:', err));
    }
    function switchData() {
      const sel = document.getElementById('yearSelector');
      loadGeoJSON(sel.value);
    }
  </script>
</body>
</html>
